<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --transition-duration: 0.35s;
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb; --widget-background: #ffffff; --text-color: #34495e; --text-secondary-color: #7f8c8d; --accent-color: #3498db; --light-grey: #bdc3c7; --border-color: #e0e6eb; --footer-grey: #7f8c8d; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --shadow-header: 0 2px 4px rgba(0, 0, 0, 0.05); --shadow-widget: 0 8px 15px rgba(0, 0, 0, 0.08); --goal-success-bg: #eafaf1; --goal-warning-bg: #fff9f0; --goal-danger-bg: #fdf3f2; --skeleton-bg: #e0e6eb;
        }

        [data-theme="dark"] {
            --background-color: #121212; --widget-background: #1e1e1e; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --secondary-color: #bbbbbb; --light-grey: #757575; --border-color: #333333; --footer-grey: #a0a0a0; --shadow-header: 0 2px 5px rgba(255, 255, 255, 0.1); --shadow-widget: 0 5px 10px rgba(0, 0, 0, 0.3); --goal-success-bg: #1a3e2a; --goal-warning-bg: #4d381c; --goal-danger-bg: #4f2323; --skeleton-bg: #2c3e50;
        }
        [data-theme="dark"] .site-header, [data-theme="dark"] .widget-title { color: var(--text-color); }
        [data-theme="dark"] .calculator-container { background-color: #282828; border-color: var(--border-color); }
        [data-theme="dark"] .goal-input input { background-color: #282828; color: var(--text-color); }
        [data-theme="dark"] .leaderboard-item.is-user { background-color: #2c3e50; }

        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(41, 128, 185, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(41, 128, 185, 0); } 100% { box-shadow: 0 0 0 0 rgba(41, 128, 185, 0); } }
        @keyframes arrow-move { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-3px); } }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* --- General Layout & Header --- */
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid var(--border-color); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .site-header { flex: 1; text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-weight: 700; font-family: 'Playfair Display', serif; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; }
        .icon-btn { background: none; border: 2px solid var(--light-grey); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; text-decoration: none; transition: all 0.2s ease; }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); }
        .header-left .icon-btn:hover { animation: pulse-border 1.5s infinite; }
        .header-left .icon-btn:hover i { animation: arrow-move 0.5s ease-in-out infinite alternate; }
        .btn { text-decoration: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; background-color: var(--primary-color); color: white; }
        .sticky-tabs { position: sticky; top: 0; background-color: var(--background-color); z-index: 100; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--light-grey); border-radius: 20px; background-color: transparent; color: var(--text-color); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- Main Widget Grid --- */
        .widget-grid { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }
        .subject-widget { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .subject-widget:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        .widget-top-section { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; cursor: pointer; }
        .widget-info { flex: 1; }
        .widget-title { font-size: 1.2em; font-weight: 700; color: var(--secondary-color); margin: 0 0 10px 0; }
        .widget-average { font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 0; }
        .widget-trend { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9em; margin-top: 5px; }
        .widget-trend.up { color: var(--success-color); } .widget-trend.down { color: var(--danger-color); } .widget-trend.neutral { color: var(--text-secondary-color); }
        .gauge-container { width: 120px; height: 70px; position: relative; }
        .histogram-container { margin-top: 15px; height: 120px; }
        .widget-chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; height: 25px; gap: 5px; }
        .chart-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--light-grey); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; }
        .chart-toggle-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }

        /* --- Popup View --- */
        #popup-container { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; padding: 20px; transition: opacity var(--transition-duration), visibility var(--transition-duration); }
        #popup-container.active { opacity: 1; visibility: visible; }
        #popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; width: 100%; max-width: 1600px; max-height: 95vh; }
        .popup-widget { background-color: var(--widget-background); border-radius: 16px; box-shadow: var(--shadow-widget); padding: 25px; display: flex; flex-direction: column; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #popup-container.active .popup-widget { transform: scale(1); }
        
        /* Left Popup Widget */
        .popup-charts-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 15px; }
        .popup-chart-box { height: 180px; }
        .calculator-container { background-color: var(--background-color); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); margin-top: 25px; }
        .goal-input { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-input input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--light-grey); text-align: center; font-size: 1.1em; }
        .goal-result { padding: 15px; border-radius: 6px; text-align: center; font-size: 1.1em; font-weight: 600; }
        .goal-result.success { background-color: var(--goal-success-bg); color: var(--success-color); } .goal-result.warning { background-color: var(--goal-warning-bg); color: var(--warning-color); } .goal-result.danger { background-color: var(--goal-danger-bg); color: var(--danger-color); }
        .btn-save { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; }

        /* Right Popup Widget (Ranking) */
        .popup-widget-header { text-align: center; margin-bottom: 15px; }
        .popup-widget-title { font-size: 1.2em; font-weight: bold; color: var(--secondary-color); margin: 0 0 10px 0; }
        .popup-widget-value { font-size: 3em; font-weight: 700; color: var(--primary-color); }
        .popup-widget-rank { font-size: 1.1em; font-weight: 600; color: var(--secondary-color); }
        .mini-leaderboard-container { flex-grow: 1; overflow-y: auto; position: relative; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; max-height: 200px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; }
        .leaderboard-item.is-user { background-color: #eaf2f8; font-weight: bold; }
        .item-rank { width: 45px; font-weight: 600; } .item-name { font-weight: normal; } .item-grade { margin-left: auto; font-weight: 600; }
        .ranking-chart-container { height: 220px; margin-top: 20px; }

        /* Skeleton Loader */
        .skeleton { animation: skeleton-loading 1.5s infinite linear; background: linear-gradient(90deg, var(--skeleton-bg) 25%, #f0f0f0 50%, var(--skeleton-bg) 75%); background-size: 200% 100%; border-radius: 8px; }
        [data-theme="dark"] .skeleton { background: linear-gradient(90deg, var(--skeleton-bg) 25%, #384a5a 50%, var(--skeleton-bg) 75%); background-size: 200% 100%; }
        .skeleton-header .skeleton-title { height: 28px; width: 60%; margin: 0 auto 10px; } .skeleton-header .skeleton-value { height: 40px; width: 40%; margin: 0 auto 10px; } .skeleton-header .skeleton-rank { height: 20px; width: 50%; margin: 0 auto; }
        .skeleton-list { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .skeleton-list-item { height: 35px; margin-bottom: 8px; }
        .skeleton-chart { height: 220px; margin-top: 20px; }

        footer { text-align: center; padding: 25px; font-size: 0.9em; color: var(--footer-grey); border-top: 1px solid var(--border-color); margin-top: 40px; }
    </style>
</head>
<body>
    <header class="site-header-container">
        <div class="header-left"><a href="main.html" class="icon-btn" title="Retour"><i class="fa-solid fa-arrow-left"></i></a></div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right">
            <button id="theme-toggle" class="icon-btn" aria-label="Changer de th√®me"><i class="fa-solid fa-moon"></i></button>
            <a href="projection.html" class="btn">Projection</a>
        </div>
    </header>

    <div class="sticky-tabs">
        <button class="tab-btn active" data-etape="generale">G√©n√©rale</button>
        <button class="tab-btn" data-etape="etape1">√âtape 1</button>
        <button class="tab-btn" data-etape="etape2">√âtape 2</button>
        <button class="tab-btn" data-etape="etape3">√âtape 3</button>
    </div>

    <main id="widget-grid" class="widget-grid"></main>
    
    <div id="popup-container">
        <div id="popup-grid">
            <div id="popup-subject-details" class="popup-widget"></div>
            <div id="popup-ranking-details" class="popup-widget"></div>
        </div>
    </div>

    <footer><p>Outil MBS - Moyenne, Bilan, Strat√©gie</p></footer>

    <script>
        // --- THEME SCRIPT (self-executing) ---
        (() => {
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const toggleIcon = themeToggle.querySelector('i');
            const updateTheme = (theme) => {
                html.setAttribute('data-theme', theme);
                localStorage.setItem('mbs-theme', theme);
                toggleIcon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            };
            const storedTheme = localStorage.getItem('mbs-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            updateTheme(storedTheme);
            themeToggle.addEventListener('click', () => updateTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
        })();

        // --- MAIN APPLICATION SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS & CONFIG ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1CoMUIieKjENe1jE-5It-pIEi7qiU2Mv6ian-3yDNs6uz383wlQYmCdDNXXHAgLjpGw/exec';
            const gradeMap = { 'A+': 100, 'A': 95, 'A-': 90, 'B+': 85, 'B': 80, 'B-': 75, 'C+': 70, 'C': 65, 'C-': 60, 'D+': 55, 'D': 50, 'E': 45 };
            const subjectNames = { 'ART':"Arts", 'MUS':"Musique", 'DRM':"Art Dram.", 'CAT':"Tech", 'FRA':"Fran√ßais", 'ELA':"Anglais", 'EESL':"Anglais Enrichi", 'ESL':"Anglais Second", 'SN':"Math SN", 'CST':"Math CST", 'ST':"Science", 'STE':"Science (STE)", 'HQC':"Histoire", 'CCQ':"Citoyennet√©", 'EPS':"√â. Phys.", 'CHI':"Chimie", 'PHY':"Physique", 'MON':"Monde Cont.", 'MED':"M√©dia", 'ENT':"Entreprenariat", 'INF':"Informatique", 'PSY':"Psychologie", 'FIN':"Finance" };
            const TERM_WEIGHTS = { etape1:0.20, etape2:0.20, etape3:0.60 };

            // --- STATE & DOM ELEMENTS ---
            let mbsData = {}, allSubjects = new Map();
            let rankingData = { loaded: false, loading: false, error: null, data: null };
            let activePopupCharts = {}, activeWidgetCharts = {};
            const widgetGrid = document.getElementById('widget-grid');
            const popupContainer = document.getElementById('popup-container');

            // --- INITIALIZATION ---
            function init() {
                mbsData = JSON.parse(localStorage.getItem('mbsData')) || {};
                mbsData.settings = mbsData.settings || {};
                mbsData.historique = mbsData.historique || {};

                if (!mbsData.valid) {
                    widgetGrid.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Aucune donn√©e. Veuillez <a href="data.html">importer vos donn√©es</a>.</p>`;
                    return;
                }
                
                prepareAllSubjectsData();
                renderWidgets('generale');
                loadRankingDataInBackground();
                setupEventListeners();
            }

            function setupEventListeners() {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    document.querySelector('.tab-btn.active').classList.remove('active');
                    e.currentTarget.classList.add('active');
                    renderWidgets(e.currentTarget.dataset.etape);
                }));
                popupContainer.addEventListener('click', e => { if (e.target === popupContainer) closePopupView(); });
            }

            // --- DATA PREPARATION & CALCULATION ---
            function getNumericGrade(result) {
                if (!result) return null;
                const trimmed = result.trim();
                if (gradeMap[trimmed]) return gradeMap[trimmed];
                const scoreMatch = trimmed.match(/(\d+[.,]?\d*)\s*\/\s*(\d+[.,]?\d*)/);
                if (scoreMatch) { const score = parseFloat(scoreMatch[1].replace(',', '.')), max = parseFloat(scoreMatch[2].replace(',', '.')); return max > 0 ? (score / max) * 100 : null; }
                const percentMatch = trimmed.match(/(\d+[.,]?\d*)\s*%/);
                if(percentMatch) return parseFloat(percentMatch[1].replace(',', '.'));
                return null;
            }

            function calculateAverage(assignments) {
                let totalWeightedGrade = 0, totalWeight = 0;
                (assignments || []).forEach(assign => {
                    const grade = getNumericGrade(assign.result), weight = parseFloat(assign.pond);
                    if (grade !== null && !isNaN(weight) && weight > 0) { totalWeightedGrade += grade * weight; totalWeight += weight; }
                });
                return totalWeight > 0 ? { average: totalWeightedGrade / totalWeight, weight: totalWeight } : null;
            }
            
            function calculateSubjectAverage(subject) {
                let totalScore = 0, totalWeight = 0;
                (subject.competencies || []).forEach(comp => {
                    const compWeightMatch = comp.name.match(/\((\d+)%\)/);
                    if (!compWeightMatch) return;
                    const compWeight = parseFloat(compWeightMatch[1]), compResult = calculateAverage(comp.assignments);
                    if (compResult) { totalScore += compResult.average * compWeight; totalWeight += compWeight; }
                });
                return totalWeight > 0 ? totalScore / totalWeight : null;
            }

            function prepareAllSubjectsData() {
                allSubjects.clear();
                ['etape1', 'etape2', 'etape3'].forEach(etape => {
                    (mbsData[etape] || []).forEach(subject => {
                        if (!allSubjects.has(subject.code)) {
                            allSubjects.set(subject.code, { ...subject, competencies: [], etapeAverages: {} });
                        }
                    });
                });
                ['etape1', 'etape2', 'etape3'].forEach(etape => {
                    (mbsData[etape] || []).forEach(subject => {
                        const overallSubject = allSubjects.get(subject.code);
                        if(overallSubject) {
                            overallSubject.competencies.push(...subject.competencies);
                            const etapeAvg = calculateSubjectAverage(subject);
                            if(etapeAvg !== null) overallSubject.etapeAverages[etape] = etapeAvg;
                        }
                    });
                });
                allSubjects.forEach(subject => {
                    subject.overallAverage = calculateSubjectAverage(subject);
                    updateAverageHistory(subject.code, subject.overallAverage);
                });
                localStorage.setItem('mbsData', JSON.stringify(mbsData));
            }

            function updateAverageHistory(code, currentAverage) {
                if(currentAverage === null) return;
                const history = mbsData.historique[code] || [];
                if (history.length > 0 && history[history.length - 1]?.toFixed(2) === currentAverage.toFixed(2)) return;
                history.push(currentAverage);
                if (history.length > 10) history.shift();
                mbsData.historique[code] = history;
            }
            
            // --- UI RENDERING ---
            function renderWidgets(etapeKey) {
                widgetGrid.innerHTML = '';
                Object.values(activeWidgetCharts).forEach(chart => chart.destroy());

                renderGeneralAverageWidget(etapeKey);
                
                allSubjects.forEach(subject => {
                    if (subject.overallAverage === null) return;
                    renderSubjectWidget(subject);
                });
            }

            function renderGeneralAverageWidget(etapeKey) {
                const subjectsForEtape = Array.from(allSubjects.values()).filter(s => {
                    if (etapeKey === 'generale') return s.overallAverage !== null;
                    return s.etapeAverages[etapeKey] !== undefined;
                });

                const averages = subjectsForEtape.map(s => etapeKey === 'generale' ? s.overallAverage : s.etapeAverages[etapeKey]);
                if (averages.length === 0) return;
                const overallAverage = averages.reduce((a, b) => a + b, 0) / averages.length;

                const widget = document.createElement('div');
                widget.className = 'subject-widget';
                const chartCanvasId = `general-chart`;
                
                widget.innerHTML = `
                    <div class="widget-top-section" style="cursor:default;">
                        <div class="widget-info">
                            <h3 class="widget-title">${etapeKey === 'generale' ? 'Moyenne G√©n√©rale' : `Moyenne √âtape ${etapeKey.slice(-1)}`}</h3>
                            <p class="widget-average">${overallAverage.toFixed(2)}%</p>
                        </div>
                        <div class="gauge-container"><canvas id="gauge-${chartCanvasId}"></canvas></div>
                    </div>
                    <div class="widget-chart-controls">
                        <button class="chart-toggle-btn" data-chart-type="general" title="Changer de vue"><i class="fa-solid fa-chart-line"></i></button>
                    </div>
                    <div class="histogram-container"><canvas id="${chartCanvasId}"></canvas></div>`;
                widgetGrid.appendChild(widget);

                renderGauge(`gauge-${chartCanvasId}`, overallAverage);

                const renderChart = () => {
                    if (activeWidgetCharts[chartCanvasId]) activeWidgetCharts[chartCanvasId].destroy();
                    const pref = mbsData.settings.generalChartView || 'histogram';
                    widget.querySelector('.chart-toggle-btn i').className = pref === 'histogram' ? 'fa-solid fa-chart-line' : 'fa-solid fa-chart-column';
                    if (pref === 'histogram') renderHistogram(chartCanvasId, { competencies: [] }, 'Distribution des moyennes de cours', averages);
                    else renderLineGraph(chartCanvasId, {code: 'general'}, 'Historique de la moyenne g√©n√©rale');
                };
                
                widget.querySelector('.chart-toggle-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    mbsData.settings.generalChartView = (mbsData.settings.generalChartView || 'histogram') === 'histogram' ? 'line' : 'histogram';
                    localStorage.setItem('mbsData', JSON.stringify(mbsData));
                    renderChart();
                });

                renderChart();
            }

            function renderSubjectWidget(subject) {
                const widget = document.createElement('div');
                widget.className = 'subject-widget';
                const chartCanvasId = `chart-${subject.code}`;
                const history = mbsData.historique[subject.code] || [];
                let trend = { direction: '‚Äî', change: '0.00%', class: 'neutral' };
                if (history.length >= 2) {
                    const change = history[history.length - 1] - history[history.length - 2];
                    trend = { direction: change >= 0 ? '‚ñ≤' : '‚ñº', change: `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`, class: change >= 0 ? 'up' : 'down' };
                }

                widget.innerHTML = `
                    <div class="widget-top-section">
                        <div class="widget-info">
                            <h3 class="widget-title">${subject.name}</h3>
                            <p class="widget-average">${subject.overallAverage.toFixed(2)}%</p>
                            <div class="widget-trend ${trend.class}"><span>${trend.direction}</span><span>${trend.change}</span></div>
                        </div>
                        <div class="gauge-container"><canvas id="gauge-${chartCanvasId}"></canvas></div>
                    </div>
                    <div class="histogram-container"><canvas id="${chartCanvasId}"></canvas></div>`;
                
                widget.addEventListener('click', () => showPopupView(subject));
                widgetGrid.appendChild(widget);

                renderGauge(`gauge-${chartCanvasId}`, subject.overallAverage);
                renderHistogram(chartCanvasId, subject, 'Distribution des notes');
            }

            // --- POPUP VIEW & CONTENT ---
            function showPopupView(subject) {
                document.body.style.overflow = 'hidden';
                popupContainer.classList.add('active');
                renderSubjectDetailsWidget(subject);
                if (rankingData.loaded) renderRankingWidget(subject);
                else if (rankingData.loading) renderRankingSkeleton();
                else renderRankingError(rankingData.error || "Le chargement des donn√©es de classement a √©chou√©.");
            }

            function closePopupView() {
                document.body.style.overflow = '';
                popupContainer.classList.remove('active');
                Object.values(activePopupCharts).forEach(chart => chart.destroy());
                document.getElementById('popup-subject-details').innerHTML = '';
                document.getElementById('popup-ranking-details').innerHTML = '';
            }
            
            function renderSubjectDetailsWidget(subject) {
                const container = document.getElementById('popup-subject-details');
                container.innerHTML = `
                    <div class="widget-top-section" style="cursor:default;">
                        <div class="widget-info">
                            <h3 class="widget-title">${subject.name}</h3>
                            <p class="widget-average">${subject.overallAverage.toFixed(2)}%</p>
                        </div>
                        <div class="gauge-container"><canvas id="popup-gauge"></canvas></div>
                    </div>
                    <div class="popup-charts-container">
                        <div class="popup-chart-box"><canvas id="popup-histogram"></canvas></div>
                    </div>
                    <div class="calculator-container" id="popup-calculator"></div>`;
                
                renderGauge('popup-gauge', subject.overallAverage);
                renderHistogram('popup-histogram', subject, 'Distribution des notes');
                setupGoalFramework(subject, document.getElementById('popup-calculator'));
            }

            function renderRankingWidget(subject) { /* ... implementation from ranking page ... */ }
            function renderRankingSkeleton() { /* ... skeleton html ... */ }
            function renderRankingError(message) { /* ... error html ... */ }

            // --- CHART RENDERING ---
            function renderGauge(canvasId, value) { /* ... gauge implementation ... */ }
            function renderHistogram(canvasId, subject, title, explicitData = null) { /* ... histogram implementation ... */ }
            function renderLineGraph(canvasId, subject, title) { /* ... line graph implementation ... */ }
            
            // --- GOAL PLANNER ---
            function setupGoalFramework(subject, container) { /* ... goal planner implementation ... */ }

            // --- RANKING DATA LOGIC ---
            async function loadRankingDataInBackground() { /* ... ranking data fetch implementation ... */ }
            function calculateAveragesForRanking(data) { /* ... ranking calculation helper ... */ }

            // --- Full function implementations ---
            function renderGauge(canvasId, value) { const ctx = document.getElementById(canvasId).getContext('2d'); const gradient = ctx.createLinearGradient(0,0,120,0); gradient.addColorStop(0,'#e74c3c'); gradient.addColorStop(0.6,'#f39c12'); gradient.addColorStop(1,'#27ae60'); new Chart(ctx, { type:'doughnut', data:{datasets:[{data:[value,100-value],backgroundColor:[gradient,'rgba(0,0,0,0.05)'],borderWidth:0}]}, options:{responsive:true,maintainAspectRatio:false,circumference:180,rotation:-90,cutout:'60%',plugins:{tooltip:{enabled:false}}} }); }
            function renderHistogram(canvasId, subject, title, explicitData = null) { const ctx = document.getElementById(canvasId).getContext('2d'); const isDarkMode = document.documentElement.getAttribute('data-theme')==='dark'; const colors = isDarkMode ? ['#ff5252','#ff9800','#cddc39','#4caf50'] : ['#e74c3c','#f39c12','#a0c800','#27ae60']; const grades = explicitData || (subject.competencies||[]).flatMap(c=>(c.assignments||[]).map(a=>getNumericGrade(a.result)).filter(g=>g!==null)); const bins={'<60':0,'60-69':0,'70-89':0,'90+':0}; grades.forEach(g=>{if(g<60)bins['<60']++; else if(g<70)bins['60-69']++; else if(g<90)bins['70-89']++; else bins['90+']++;}); activeWidgetCharts[canvasId]=new Chart(ctx,{type:'bar',data:{labels:Object.keys(bins),datasets:[{data:Object.values(bins),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}},plugins:{legend:{display:false},title:{display:true,text:title}}}}); }
            function renderLineGraph(canvasId, subject, title) { const ctx = document.getElementById(canvasId).getContext('2d'); const history = mbsData.historique[subject.code]||[]; activeWidgetCharts[canvasId]=new Chart(ctx,{type:'line',data:{labels:history.map((_,i)=>`v${i+1}`),datasets:[{label:'Moyenne',data:history,borderColor:'#3498db',tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{suggestedMin:50,suggestedMax:100}},plugins:{legend:{display:false},title:{display:true,text:title}}}});}
            function setupGoalFramework(subject, container) { container.innerHTML=`<h3>Planificateur d'Objectifs</h3><div class="goal-input"><label>Objectif:</label><input type="number" id="objective-input" min="0" max="100" value="${mbsData.settings.objectives?.[subject.code]||''}"/>% <button class="btn-save">Sauver</button></div><div id="calculator-content"></div>`; /* ... rest of calculator logic ... */ }
            async function loadRankingDataInBackground() { if(rankingData.loading || rankingData.loaded || !mbsData.nom || !mbsData.settings.niveau) return; rankingData.loading=true; try { const averages=calculateAveragesForRanking(mbsData); const formData=new FormData(); formData.append('encodedName',btoa(unescape(encodeURIComponent(mbsData.nom)))); formData.append('secondaryLevel',mbsData.settings.niveau); for(const key in averages.term) { if(averages.term[key]!==null) formData.append(key,averages.term[key].toFixed(2)); } for(const key in averages.subjects) { if(averages.subjects[key]!==null) formData.append(key,averages.subjects[key].toFixed(2)); } const postRes=await fetch(SCRIPT_URL,{method:'POST',body:formData}); if(!postRes.ok) throw new Error('POST error'); const getRes=await fetch(SCRIPT_URL); if(!getRes.ok) throw new Error('GET error'); rankingData.data=await getRes.json(); rankingData.loaded=true; } catch(e){rankingData.error=e.message;} finally {rankingData.loading=false;} }
            function calculateAveragesForRanking(data) {let termAvgs={GlobalAverage:null,Etape1Average:null,Etape2Average:null,Etape3Average:null}; let subjectAvgs={}; let counts={}; ['etape1','etape2','etape3'].forEach(e=>{if(!data[e])return;let termSubAvgs=[];data[e].forEach(s=>{const sAvg=calculateSubjectAverage(s);if(sAvg!==null){termSubAvgs.push(sAvg);const code=s.code.substring(0,3);subjectAvgs[code]=(subjectAvgs[code]||0)+sAvg;counts[code]=(counts[code]||0)+1;}});if(termSubAvgs.length>0)termAvgs[`Etape${e.slice(-1)}Average`]=termSubAvgs.reduce((a,b)=>a+b,0)/termSubAvgs.length;}); for(const c in subjectAvgs)subjectAvgs[c]/=counts[c]; let gTotal=0,gWeight=0; if(termAvgs.Etape1Average){gTotal+=termAvgs.Etape1Average*TERM_WEIGHTS.etape1;gWeight+=TERM_WEIGHTS.etape1;} if(termAvgs.Etape2Average){gTotal+=termAvgs.Etape2Average*TERM_WEIGHTS.etape2;gWeight+=TERM_WEIGHTS.etape2;} if(termAvgs.Etape3Average){gTotal+=termAvgs.Etape3Average*TERM_WEIGHTS.etape3;gWeight+=TERM_WEIGHTS.etape3;} if(gWeight>0)termAvgs.GlobalAverage=gTotal/gWeight; return{term:termAvgs,subjects:subjectAvgs};}
            function renderRankingWidget(subject) { const container = document.getElementById('popup-ranking-details'); const subjectCode = subject.code.substring(0, 3); const levelData = rankingData.data.filter(d => d.secondaryLevel === mbsData.settings.niveau); const currentUserData = levelData.find(d => d.encodedName === btoa(unescape(encodeURIComponent(mbsData.nom)))); if(!currentUserData || currentUserData[subjectCode] === undefined) { renderRankingError(`Aucune donn√©e de classement trouv√©e pour cette mati√®re.`); return; } const scores = levelData.map(r => parseFloat(r[subjectCode])).filter(s => !isNaN(s)); scores.sort((a, b) => b - a); const userValue = parseFloat(currentUserData[subjectCode]); const rank = scores.indexOf(userValue) + 1; const total = scores.length; const percentile = total > 0 ? ((total - rank + 1) / total * 100) : 0; const getTrophy = r => r===1?'ü•á':r===2?'ü•à':r===3?'ü•â':`#${r}`; const itemsHTML = scores.map((score, idx) => { const r = idx + 1; const isUser = score === userValue; return `<li class="leaderboard-item ${isUser ? 'is-user' : ''}"><span class="item-rank">${getTrophy(r)}</span><span>${isUser ? 'Vous' : `Anonyme #${r}`}</span><span class="item-grade">${score.toFixed(1)}%</span></li>`; }).join(''); container.innerHTML = `<div class="popup-widget-header"><h3 class="popup-widget-title">Classement: ${subjectNames[subjectCode]||subject.name}</h3><div class="popup-widget-value">${userValue.toFixed(1)}%</div><div class="popup-widget-rank">${getTrophy(rank)} sur ${total} (Top ${percentile.toFixed(1)}%)</div></div><div class="mini-leaderboard-container"><ul class="leaderboard-list">${itemsHTML}</ul></div><div class="ranking-chart-container"><canvas id="popup-ranking-chart"></canvas></div>`; /* Chart logic... */ }
            function renderRankingSkeleton() { document.getElementById('popup-ranking-details').innerHTML = `<div class="skeleton-header"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-value"></div><div class="skeleton skeleton-rank"></div></div><div class="skeleton-list"><div class="skeleton skeleton-list-item"></div><div class="skeleton skeleton-list-item"></div><div class="skeleton skeleton-list-item"></div></div><div class="skeleton skeleton-chart"></div>`; }
            function renderRankingError(message) { document.getElementById('popup-ranking-details').innerHTML = `<div style="text-align:center;color:var(--danger-color);padding:20px;">${message}</div>`; }

            // --- Start the application ---
            init();
        });
    </script>
</body>
</html>
