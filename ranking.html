<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classements - Outil MBS</title>
    <!-- Add your CSS from the other page, or use this simple style -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; color: #34495e; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 15px rgba(0,0,0,0.08); }
        h1, h2 { font-family: 'Playfair Display', serif; }
        .loading, .error { text-align: center; font-size: 1.2em; color: #7f8c8d; }
        .rank-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .rank-card { border: 1px solid #e0e6eb; border-radius: 10px; padding: 20px; text-align: center; }
        .rank-card h3 { margin: 0 0 10px; font-size: 1em; color: #2980b9; }
        .rank-value { font-size: 2.5em; font-weight: 600; }
        .rank-details { font-size: 0.9em; color: #7f8c8d; }
        .percentile { font-weight: bold; }
        .subject-table { width: 100%; border-collapse: collapse; }
        .subject-table th, .subject-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e6eb; }
        .subject-table th { background-color: #f7f9fb; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container" id="ranking-container">
        <h1>Vos Classements</h1>
        <div id="status-message" class="loading">Envoi des données et calcul des classements...</div>
        
        <div id="overall-ranks" style="display: none;">
            <h2>Classements Généraux</h2>
            <div class="rank-grid"></div>
        </div>

        <div id="subject-ranks" style="display: none;">
            <h2>Classements par Matière</h2>
            <table class="subject-table">
                <thead><tr><th>Matière</th><th>Classement</th><th>Percentile</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- PASTE YOUR GOOGLE APPS SCRIPT URL HERE ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZdCChWXoKZGjLce05c26OJSDJ1Vn4iOwE-oy3_Md8Ax_IWbX2oxkaZmtM462VNheghw/exec';
        // ---------------------------------------------

        const subjectNames = { 'ART': "Arts Plastiques", 'MUS': "Musique", 'DRM': "Art Dramatique", 'CAT': "Tech", 'FRA': "Français", 'ELA': "Anglais", 'EESL': "Anglais Enrichi", 'ESL': "Anglais Second", 'SN': "Math SN", 'CST': "Math CST", 'ST': "Science", 'STE': "Science (STE)", 'HQC': "Histoire", 'CCQ': "Citoyenneté", 'EPS': "Éducation Physique", 'CHI': "Chimie", 'PHY': "Physique", 'MON': "Monde Cont.", 'MED': "Média", 'ENT': "Entreprenariat", 'INF': "Informatique", 'PSY': "Psychologie", 'FIN': "Finance" };
        const overallNames = { 'GlobalAverage': "Moyenne Globale", 'Etape1Average': "Étape 1", 'Etape2Average': "Étape 2", 'Etape3Average': "Étape 3" };
        const TERM_WEIGHTS = { etape1: 0.20, etape2: 0.20, etape3: 0.60 };

        document.addEventListener('DOMContentLoaded', initialize);

        async function initialize() {
            const statusMessage = document.getElementById('status-message');
            if (SCRIPT_URL.includes('PASTE_YOUR_WEB_APP_URL_HERE')) {
                statusMessage.textContent = "Erreur : L'URL du script d'application n'est pas configurée.";
                statusMessage.className = 'error';
                return;
            }

            // 1. Load raw data from local storage
            const mbsData = JSON.parse(localStorage.getItem('mbsData'));
            if (!mbsData || !mbsData.valid) {
                statusMessage.textContent = "Erreur : Données 'mbsData' introuvables. Veuillez d'abord utiliser les autres outils.";
                statusMessage.className = 'error';
                return;
            }

            // 2. Prepare data to send
            const averages = calculateAveragesFromRawData(mbsData);
            const encodedName = btoa(mbsData.nom); // Encode name in Base64
            const payload = {
                encodedName: encodedName,
                secondaryLevel: mbsData.settings.niveau,
                averages: averages.term,
                subjects: averages.subjects
            };

            // 3. Send data and get rankings
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });

                const rankData = await response.json();
                if (rankData.error) throw new Error(rankData.error);
                
                statusMessage.style.display = 'none';
                displayRankings(rankData);

            } catch (error) {
                statusMessage.textContent = `Erreur lors de la communication avec le serveur de classement : ${error.message}`;
                statusMessage.className = 'error';
                console.error(error);
            }
        }

        function displayRankings(rankData) {
            const overallContainer = document.querySelector('#overall-ranks .rank-grid');
            const subjectContainer = document.querySelector('#subject-ranks tbody');
            
            document.getElementById('overall-ranks').style.display = 'block';
            document.getElementById('subject-ranks').style.display = 'block';
            
            // Display overall ranks
            for (const key in rankData.overall) {
                const data = rankData.overall[key];
                if (!data.rank) continue;
                overallContainer.innerHTML += `
                    <div class="rank-card">
                        <h3>${overallNames[key] || key}</h3>
                        <div class="rank-value">${data.rank} / ${data.total}</div>
                        <div class="rank-details">Top <span class="percentile">${data.percentile}%</span></div>
                    </div>
                `;
            }

            // Display subject ranks
            for (const key in rankData.subjects) {
                const data = rankData.subjects[key];
                if (!data.rank) continue;
                subjectContainer.innerHTML += `
                    <tr>
                        <td>${subjectNames[key] || key}</td>
                        <td>${data.rank} sur ${data.total}</td>
                        <td>Top ${data.percentile}%</td>
                    </tr>
                `;
            }
        }

        // --- Calculation Helpers (from your other files) ---
        function calculateAveragesFromRawData(data) {
            let termAverages = { etape1: null, etape2: null, etape3: null };
            let allSubjectAverages = {};
            
            ['etape1', 'etape2', 'etape3'].forEach(etape => {
                if (!data[etape]) return;
                let termTotal = 0, termWeight = 0;
                data[etape].forEach(subject => {
                    let subjectTotal = 0, subjectWeight = 0;
                    subject.competencies.forEach(comp => {
                        const compWeightMatch = comp.name.match(/\((\d+)%\)/);
                        if (!compWeightMatch) return;
                        const compWeight = parseFloat(compWeightMatch[1]);
                        
                        let compTotal = 0, compAssignWeight = 0;
                        comp.assignments.forEach(assign => {
                            const grade = getNumericGrade(assign.result);
                            const weight = parseFloat(assign.pond);
                            if (grade !== null && !isNaN(weight) && weight > 0) {
                                compTotal += grade * weight;
                                compAssignWeight += weight;
                            }
                        });
                        if (compAssignWeight > 0) {
                            subjectTotal += (compTotal / compAssignWeight) * compWeight;
                            subjectWeight += compWeight;
                        }
                    });
                    if (subjectWeight > 0) {
                        const code = subject.code.substring(0, 3);
                        allSubjectAverages[code] = (allSubjectAverages[code] || 0) + (subjectTotal / subjectWeight);
                        termTotal += subjectTotal / subjectWeight;
                        termWeight += 1; // Simple average for term
                    }
                });
                if (termWeight > 0) termAverages[etape] = termTotal / termWeight;
            });

            let globalTotal = 0, globalWeight = 0;
            for (const etape in termAverages) {
                if (termAverages[etape] !== null) {
                    globalTotal += termAverages[etape] * TERM_WEIGHTS[etape];
                    globalWeight += TERM_WEIGHTS[etape];
                }
            }
            termAverages.global = globalWeight > 0 ? globalTotal / globalWeight : null;

            return { term: termAverages, subjects: allSubjectAverages };
        }

        function getNumericGrade(result) {
            if (!result) return null;
            const trimmed = result.trim().toLowerCase();
            const percentageMatch = trimmed.match(/(\d+[,.]?\d*)\s*%/);
            if (percentageMatch) return parseFloat(percentageMatch[1].replace(',', '.'));
            const scoreMatch = trimmed.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);
            if (scoreMatch) {
                const score = parseFloat(scoreMatch[1].replace(',', '.'));
                const max = parseFloat(scoreMatch[2].replace(',', '.'));
                return (max > 0) ? (score / max) * 100 : null;
            }
            return null;
        }
    </script>
</body>
</html>
